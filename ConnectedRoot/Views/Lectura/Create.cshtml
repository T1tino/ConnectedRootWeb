@model ConnectedRoot.Models.Lectura

@{
    ViewData["Title"] = "Registrar Lectura";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-plus"></i> Registrar Nueva Lectura
    </h2>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-action="Index">
                    <i class="fas fa-chart-line"></i> Lecturas
                </a>
            </li>
            <li class="breadcrumb-item active">Registrar</li>
        </ol>
    </nav>
</div>

@if (!string.IsNullOrEmpty(ViewBag.Error))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle"></i>
        @ViewBag.Error
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!string.IsNullOrEmpty(ViewBag.TipoSensor))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        <i class="fas fa-info-circle"></i>
        <strong>Registrando lectura para sensor:</strong> @ViewBag.TipoSensor
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-md-8">
        <form asp-action="Create" method="post">
            @Html.AntiForgeryToken()
            
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar"></i> Datos de la Lectura
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group mb-3">
                                <label for="SensorId" class="form-label">Sensor <span class="text-danger">*</span></label>
                                <select name="SensorId" id="SensorId" class="form-select" required>
                                    <option value="">-- Selecciona un sensor --</option>
                                    @if (ViewBag.SensoresConInfo != null)
                                    {
                                        @foreach (var sensor in ViewBag.SensoresConInfo)
                                        {
                                            @if (ViewBag.SensorSeleccionado?.ToString() == sensor.SensorId)
                                            {
                                                <option value="@sensor.SensorId" selected data-tipo="@sensor.Tipo">@sensor.Display</option>
                                            }
                                            else
                                            {
                                                <option value="@sensor.SensorId" data-tipo="@sensor.Tipo">@sensor.Display</option>
                                            }
                                        }
                                    }
                                </select>
                                <span asp-validation-for="SensorId" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-microchip"></i> 
                                    Solo se muestran sensores activos.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="Tipo" class="form-label">Tipo de Medici√≥n <span class="text-danger">*</span></label>
                                <select name="Tipo" id="Tipo" class="form-select" required>
                                    <option value="">-- Selecciona el tipo --</option>
                                    <option value="Temperatura">üå°Ô∏è Temperatura</option>
                                    <option value="Humedad del Suelo">üíß Humedad del Suelo</option>
                                    <option value="Humedad Ambiental">üå´Ô∏è Humedad Ambiental</option>
                                    <option value="Luminosidad">‚òÄÔ∏è Luminosidad</option>
                                    <option value="pH del Suelo">‚öóÔ∏è pH del Suelo</option>
                                </select>
                                <span asp-validation-for="Tipo" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="FechaHora" class="form-label">Fecha y Hora <span class="text-danger">*</span></label>
                                <input name="FechaHora" id="FechaHora" type="datetime-local" class="form-control" 
                                       value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" required />
                                <span asp-validation-for="FechaHora" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-calendar"></i> 
                                    Momento de la medici√≥n.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="Valor" class="form-label">Valor Medido <span class="text-danger">*</span></label>
                                <input name="Valor" id="Valor" type="number" step="0.01" class="form-control" 
                                       placeholder="Ej: 25.5" required />
                                <span asp-validation-for="Valor" class="text-danger"></span>
                                <div class="form-text">
                                    <i class="fas fa-tachometer-alt"></i> 
                                    Valor num√©rico de la medici√≥n.
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label for="Unidad" class="form-label">Unidad de Medida <span class="text-danger">*</span></label>
                                <select name="Unidad" id="Unidad" class="form-select" required>
                                    <option value="">-- Selecciona la unidad --</option>
                                    <option value="¬∞C">¬∞C (Grados Celsius)</option>
                                    <option value="¬∞F">¬∞F (Grados Fahrenheit)</option>
                                    <option value="%">% (Porcentaje)</option>
                                    <option value="lux">lux (Luminosidad)</option>
                                    <option value="pH">pH (Acidez/Alcalinidad)</option>
                                    <option value="ppm">ppm (Partes por mill√≥n)</option>
                                </select>
                                <span asp-validation-for="Unidad" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-4">
                <div>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a la lista
                    </a>
                </div>
                <div>
                    <button type="button" class="btn btn-outline-danger" onclick="resetForm()">
                        <i class="fas fa-undo"></i> Limpiar formulario
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Registrar Lectura
                    </button>
                </div>
            </div>
        </form>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle"></i> Valores de Referencia
                </h6>
            </div>
            <div class="card-body">
                <div id="referencia-temperatura" class="d-none">
                    <strong>üå°Ô∏è Temperatura:</strong>
                    <ul class="list-unstyled mt-2">
                        <li>üü¢ √ìptimo: 20-25¬∞C</li>
                        <li>üü° Aceptable: 15-30¬∞C</li>
                        <li>üî¥ Cr√≠tico: &lt;15¬∞C o &gt;35¬∞C</li>
                    </ul>
                </div>
                
                <div id="referencia-humedad" class="d-none">
                    <strong>üíß Humedad del Suelo:</strong>
                    <ul class="list-unstyled mt-2">
                        <li>üü¢ √ìptimo: 60-80%</li>
                        <li>üü° Seco: 40-60%</li>
                        <li>üî¥ Muy seco: &lt;40%</li>
                        <li>üî¥ Encharcado: &gt;90%</li>
                    </ul>
                </div>
                
                <div id="referencia-ph" class="d-none">
                    <strong>‚öóÔ∏è pH del Suelo:</strong>
                    <ul class="list-unstyled mt-2">
                        <li>üü¢ Neutro: 6.0-7.0</li>
                        <li>üü° √Åcido: 5.5-6.0</li>
                        <li>üü° Alcalino: 7.0-8.0</li>
                    </ul>
                </div>

                <div id="referencia-luminosidad" class="d-none">
                    <strong>‚òÄÔ∏è Luminosidad:</strong>
                    <ul class="list-unstyled mt-2">
                        <li>üü¢ Pleno sol: &gt;50,000 lux</li>
                        <li>üü° Media sombra: 10,000-50,000 lux</li>
                        <li>üî¥ Sombra: &lt;10,000 lux</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <small><strong>üí° Tip:</strong> Registra lecturas cada 2-4 horas para mejor monitoreo.</small>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-microchip"></i> Sensores Disponibles
                </h6>
            </div>
            <div class="card-body">
                @{
                    var sensoresConInfo = ViewBag.SensoresConInfo as IEnumerable<dynamic>;
                }
                @if (sensoresConInfo != null && sensoresConInfo.Any())
                {
                    <small class="text-muted">
                        Hay <strong>@sensoresConInfo.Count() sensor(es) activo(s)</strong> disponible(s) para registrar lecturas.
                    </small>
                }
                else
                {
                    <div class="alert alert-warning alert-sm">
                        <i class="fas fa-exclamation-triangle"></i>
                        <small>No hay sensores activos disponibles. 
                        <a asp-controller="Sensor" asp-action="Create">Instalar un sensor</a> primero.</small>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Mostrar valores de referencia seg√∫n el tipo seleccionado
        document.getElementById('Tipo').addEventListener('change', function() {
            // Ocultar todas las referencias
            document.querySelectorAll('[id^="referencia-"]').forEach(el => el.classList.add('d-none'));
            
            // Mostrar la referencia correspondiente
            const tipo = this.value.toLowerCase();
            if (tipo.includes('temperatura')) {
                document.getElementById('referencia-temperatura').classList.remove('d-none');
            } else if (tipo.includes('humedad')) {
                document.getElementById('referencia-humedad').classList.remove('d-none');
            } else if (tipo.includes('ph')) {
                document.getElementById('referencia-ph').classList.remove('d-none');
            } else if (tipo.includes('luminosidad')) {
                document.getElementById('referencia-luminosidad').classList.remove('d-none');
            }
            
            // Auto-seleccionar unidad seg√∫n el tipo
            const unidadSelect = document.getElementById('Unidad');
            if (tipo.includes('temperatura')) {
                unidadSelect.value = '¬∞C';
            } else if (tipo.includes('humedad')) {
                unidadSelect.value = '%';
            } else if (tipo.includes('ph')) {
                unidadSelect.value = 'pH';
            } else if (tipo.includes('luminosidad')) {
                unidadSelect.value = 'lux';
            }
        });

        // Validaci√≥n del valor seg√∫n el tipo
        document.getElementById('Valor').addEventListener('input', function() {
            const valor = parseFloat(this.value);
            const tipo = document.getElementById('Tipo').value.toLowerCase();
            
            if (isNaN(valor)) return;
            
            this.classList.remove('is-valid', 'is-invalid');
            
            if (tipo.includes('temperatura')) {
                if (valor >= -50 && valor <= 100) {
                    this.classList.add('is-valid');
                } else {
                    this.classList.add('is-invalid');
                }
            } else if (tipo.includes('humedad')) {
                if (valor >= 0 && valor <= 100) {
                    this.classList.add('is-valid');
                } else {
                    this.classList.add('is-invalid');
                }
            } else if (tipo.includes('ph')) {
                if (valor >= 0 && valor <= 14) {
                    this.classList.add('is-valid');
                } else {
                    this.classList.add('is-invalid');
                }
            } else {
                this.classList.add('is-valid');
            }
        });

        // Reset form function
        function resetForm() {
            if (confirm('¬øEst√°s seguro de limpiar todos los campos?')) {
                document.querySelector('form').reset();
                document.querySelectorAll('.is-valid, .is-invalid').forEach(function(element) {
                    element.classList.remove('is-valid', 'is-invalid');
                });
                document.querySelectorAll('[id^="referencia-"]').forEach(el => el.classList.add('d-none'));
            }
        }

        // Auto-dismiss alerts
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(function(alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);

        // Form change detection
        let formChanged = false;
        document.querySelector('form').addEventListener('input', function() {
            formChanged = true;
        });

        // Warn before leaving if form has changes
        window.addEventListener('beforeunload', function(e) {
            if (formChanged) {
                e.preventDefault();
                e.returnValue = '¬øEst√°s seguro de salir? Los cambios no guardados se perder√°n.';
                return e.returnValue;
            }
        });

        // Reset form changed flag on submit
        document.querySelector('form').addEventListener('submit', function() {
            formChanged = false;
        });
    </script>
}